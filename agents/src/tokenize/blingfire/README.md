# BlingFire Tokenizer

This directory contains a TypeScript wrapper for the [BlingFire](https://github.com/microsoft/BlingFire) tokenization library using WebAssembly.

## Overview

BlingFire is a lightning-fast tokenizer developed by Microsoft that provides high-quality sentence and word segmentation. This implementation uses the WebAssembly build of BlingFire to enable fast tokenization in TypeScript/JavaScript environments.

## Files

### Auto-generated Files

The following files are **auto-generated** and should not be manually edited:

- **`blingfire.ts`** - JavaScript code generated by Emscripten, with the following header added:
  ```typescript
  // auto generated file
  /* eslint-disable */
  // @ts-ignore
  ```
  This file is copied directly from the BlingFire build output.

- **`blingfire.wasm`** - The compiled WebAssembly binary, copied 1:1 from the BlingFire build output to the resources folder.

### Source Files

- **`blingfire_wrapper.js`** - Wrapper functions for the BlingFire WASM module. Based on the wrapper provided by BlingFire's WASM implementation, with slight adaptations for this project.

- **`index.ts`** - Main entry point that implements the `SentenceTokenizer` interface following the LiveKit agents pattern.

## Building BlingFire WASM

To regenerate the `blingfire.ts` and `blingfire.wasm` files:

### 1. Clone the BlingFire Repository

```bash
git clone https://github.com/microsoft/BlingFire.git
cd BlingFire
```

### 2. Follow Initial Setup

Follow the instructions at: https://github.com/microsoft/BlingFire/blob/master/wasm/readme.md

### 3. Modify the Makefile

Change the Makefile to run the following `em++` command:

```bash
em++ ../blingfiretools/blingfiretokdll/blingfiretokdll.cpp \
     ../blingfiretools/blingfiretokdll/*.cxx \
     ../blingfireclient.library/src/*.cpp \
     -s WASM=1 \
     -s EXPORTED_FUNCTIONS="[_GetBlingFireTokVersion, _TextToSentences, _TextToWords, _TextToIds, _SetModel, _FreeModel, _WordHyphenationWithModel, _malloc, _free]" \
     -s "EXPORTED_RUNTIME_METHODS=['lengthBytesUTF8', 'stackAlloc', 'stringToUTF8', 'UTF8ToString', 'cwrap']" \
     -s ALLOW_MEMORY_GROWTH=1 \
     -s DISABLE_EXCEPTION_CATCHING=0 \
     -s MODULARIZE=1 \
     -s EXPORT_ES6 \
     -I ../blingfireclient.library/inc/ \
     -I ../blingfirecompile.library/inc/ \
     -DHAVE_ICONV_LIB \
     -DHAVE_NO_SPECSTRINGS \
     -D_VERBOSE \
     -DBLING_FIRE_NOAP \
     -DBLING_FIRE_NOWINDOWS \
     -DNDEBUG \
     -O3 \
     --std=c++11 \
     -o blingfire.js
```

**Key Changes:**
- Added `-s MODULARIZE=1` - Makes the output a module that can be imported
- Added `-s EXPORT_ES6` - Exports as ES6 module
- Fixed `_malloc` and `_free` exports in `EXPORTED_FUNCTIONS`

### 4. Copy Files to LiveKit

After building, copy the generated files:

```bash
# From the BlingFire wasm build directory
cp blingfire.js /path/to/livekit/agents-js/agents/src/tokenize/blingfire/blingfire.ts
cp blingfire.wasm /path/to/livekit/agents-js/agents/src/tokenize/blingfire/blingfire.wasm
```

Then add the header comments to `blingfire.ts`:

```typescript
// auto generated file
/* eslint-disable */
// @ts-ignore
```

## Usage

```typescript
import { tokenizer } from '@livekit/agents';

// Create a tokenizer instance
const tokenizer = new tokenizer.blingfire.SentenceTokenizer({
  minSentenceLength: 20,
  streamContextLength: 10,
});

// Batch tokenization
const sentences = tokenizer.tokenize('This is a sentence. And another one.');
console.log(sentences);
// Output: ['This is a sentence. And another one.']

// Stream tokenization
const stream = tokenizer.stream();
stream.pushText('This is the first sentence. ');
stream.pushText('This is the second sentence.');
stream.endInput();

for await (const { token, segmentId } of stream) {
  console.log(token);
}
```

## Configuration Options

- **`minSentenceLength`** (default: 20) - Minimum length for buffered sentences
- **`streamContextLength`** (default: 10) - Minimum context length for stream processing

## Features

- Lightning-fast sentence tokenization using BlingFire
- Support for batch and streaming tokenization
- Handles abbreviations (Dr., Mr., etc.) correctly
- Supports numbers with decimals
- Multi-language support (Latin, CJK characters, etc.)
- Compatible with the LiveKit agents tokenizer interface

## License

BlingFire is licensed under the MIT License by Microsoft Corporation.
See: https://github.com/microsoft/BlingFire/blob/master/LICENSE