# SPDX-FileCopyrightText: 2024 LiveKit, Inc.
#
# SPDX-License-Identifier: Apache-2.0

# Tests run for all PRs including community contributions from forks.
# Forked PRs require manual approval before running (configured in repo settings).

name: Test
on:
  push:
    branches: [next, main, 0.x]
  pull_request:
    branches: [next, main, 0.x]
  # Allow forked PRs to run tests (requires manual approval)
  pull_request_target:
    branches: [next, main, 0.x]

jobs:
  build:
    name: Test
    # Run for pushes, internal PRs, and forked PRs (via pull_request_target)
    # Avoid duplicate runs: skip pull_request for forks (pull_request_target handles those)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request_target' ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          # For pull_request_target, checkout the PR head commit instead of base
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || '' }}
      - uses: pnpm/action-setup@v4
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm build
      - name: Check which tests to run
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            agents-or-tests:
              - 'agents/**'
              - 'plugins/test/**'
            plugins: 
              - 'plugins/**'
      - name: Test agents
        if: steps.filter.outputs.agents-or-tests == 'true' || github.event_name == 'push' || github.event_name == 'pull_request_target'
        run: pnpm test agents
      # TODO (AJS-83) Re-enable once plugins are refactored with abort controllers
      # - name: Test all plugins
      #   if: steps.filter.outputs.agents-or-tests == 'true' || github.event_name != 'pull_request'
      #   env:
      #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      #     ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
      #     DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
      #     CARTESIA_API_KEY: ${{ secrets.CARTESIA_API_KEY }}
      #     NEUPHONIC_API_KEY: ${{ secrets.NEUPHONIC_API_KEY }}
      #     RESEMBLE_API_KEY: ${{ secrets.RESEMBLE_API_KEY }}
      #   run: pnpm test plugins
      # - name: Test specific plugins
      #   if: steps.filter.outputs.agents-or-tests == 'false' && steps.filter.outputs.plugins == 'true' && github.event_name == 'pull_request'
      #   env:
      #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      #     ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
      #     DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
      #     CARTESIA_API_KEY: ${{ secrets.CARTESIA_API_KEY }}
      #     NEUPHONIC_API_KEY: ${{ secrets.NEUPHONIC_API_KEY }}
      #     RESEMBLE_API_KEY: ${{ secrets.RESEMBLE_API_KEY }}
      #   run: |
      #     plugins=$(git diff-tree --name-only --no-commit-id -r ${{ github.sha }} | grep '^plugins.*\.ts$' | cut -d/ -f2 | sort -u | tr '\n' ' ')
      #     read -ra plugins <<< "$plugins"
      #     for plugin in "${plugins[@]}"; do
      #       pnpm test $plugin
      #     done
